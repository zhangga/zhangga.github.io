---
title: 游戏服务器网络库
date: 2021-12-06 19:37:35
tags:
  - 网络
id: servernet
categories:
  - 服务器技术
---

最近在开发golang的游戏服网络库，基础开发已经完成，准备做性能测试，在思考测试用例的时候，参考了下主要网络库的测试场景，在这里做一下汇总。

## 游戏网络库

#### 背景

通过封装TCP/UDP网络连接，向上层业务提供 **可靠、易用** 的网络库。

获取网络层的控制权，先于业务做一些探索并最终赋能业务。

<!-- more -->

#### 特性

1. 易用性

* 遵循golang net的接口规范，保证通用性。
* 弱网环境下保证消息顺序、可靠，不需要业务层做额外工作。
* 可以发送可靠消息，TCP消息，UDP消息。
* 方便开启/关闭TCP/UDP以及双通道通信。

2. 可靠性

* 对网络连接进一步封装成逻辑连接(session)，将短时间内的断线重连作为同一个连接，对业务层透明。
* 保证任何情况下消息的可靠，在TCP/UDP上封装KCP，保证UDP的可靠，以及断线重连下同一个逻辑连接(不同的TCP连接)消息的可靠性。
* 支持上行/下行分别走不同的通道。
* 针对游戏大包下发的场景(如登录游戏，进入场景/副本等)，优先使用TCP发包。
* 根据网络时延自动选择TCP或UDP。
* 网络连接自动选择就近IP，登录到就近部署区域。

#### 总结

针对游戏服务器特性在设计网络库的时候需要特别关注的一些地方：

1. 游戏业务重。在handler中处理一条消息业务的时候一般都涉及到I/O操作，如果同步执行的话，CPU主要消耗会在等待I/O操作上。此时handler必须要异步处理，这就涉及到上下文切换、I/O协作等需要考虑的代价。
2. 过多长链接的问题。在使用golang net网路库设计框架时，一般都是新启一个协程goroutine去处理一个连接的read事件，在大量连接的情况下需要考虑协程的上下文切换开销，以及空闲连接占用的问题。
3. 网络库在处理消息合包/拆包的情况下，对消息buffer的拷贝次数。常用的方案是RingBuffer和[Nocopy Buffer](https://www.infoq.cn/article/fea7chf9moohbxbtyres)，参考netty和netpoll。
4. 必须收到完整的数据包才可以继续处理，不能收到一半就开始处理。
5. 水平触发、边缘触发，对编程模型的影响。

## netpoll

[netpoll](https://github.com/cloudwego/netpoll)

[netpoll-benchmark](https://github.com/cloudwego/netpoll-benchmark)

