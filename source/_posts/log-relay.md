---
title: 日志中转服
tags:
  - UE
id: log-relay
categories:
  - 笔记
date: 2025-11-17 21:27:48
---

最近在将单人战场的DS服务器从在线改成客户端本地运行，降低在线DS服务器的成本。其中原本在DS进行的BI埋点日志，需要客户端来进行上报了。

## 面临的问题

#### 业务上

1. 客户端在本地Standalone模式下，基本所有上报的代码都是可以运行的（只有极少部分DedicateServer.ts中的依赖消息的代码需要单独在Standalone模式兼容下日志埋点），这块工作量非常少。
2. 怪物和宝箱的掉落由GameServer来进行控制。

#### 框架上

1. 客户端直接向数仓上报日志面临的问题：
   1. 容易作弊，垃圾数据污染数仓
   2. 上报日志可能不完整，影响数仓的数据准确性
   3. 运营和数分的要求是一场战斗的日志必须是完整的，如果中间丢了一部分非常影响整体的分析
2. 最终决定采用客户端将整场战斗的日志文件发往日志中转服，由中转服进行日志采集发往数仓。

## 设计要求

**看似简单的一个文件服务器，其实在设计上对安全性和性能有较高的要求**

1. 校验日志文件是否合法，客户端不能篡改文件随意上传
2. 按行校验文件中json格式内容数据
3. 将校验后的多个日志文件，最后按小时为单位合并入一个日志文件（方便日志采集组件），最好能做到零拷贝、零GC

![pic-1](https://github.com/zhangga/picx-images-hosting/raw/master/filerelay-1.3gotv9pdhw.webp)

![pic-2](https://github.com/zhangga/picx-images-hosting/raw/master/filerelay-2.5c1enw202k.webp)

## 请求校验

1. **通过GameServer来生成签名，控制整体战场日志请求的真实性**
   1. 客户端无法伪造签名，只有真正通过GS请求拿到单机关卡的签名才能发起有效请求
   2. 一个战场的签名只能成功使用一次，即战斗日志被服务器接收成功后就不能再次使用
   3. 签名有效期2小时
2. 日志文件大小不能超过500k
3. **日志文件内容校验，防止客户端恶意篡改文件污染数仓**
   1. 签名中带有RoleId,BattleId，客户端无法篡改，服务器接收完文件后，后台线程校验文件内容，每条日志的RoleId,BattleId没有被篡改，才会将该日志文件放到`log-collector`采集的目录
   2. 这样即使客户端恶意篡改日志文件，也只会影响到他自己的某一场战斗

## 请求频控

1. 该HTTP接口最外层LB加个防护（比如针对每个客户端，每分钟最多请求5次）
2. 日志服内部也会对请求做限流

