---
title: work
tags:
  - 笔记
id: work
categories:
  - 笔记
---

#### 工作总结

- 概述：字节工作概述，和之前做项目有比较大的区别，主要以下三个方面。

  1. 技术中心在推动的服务器框架，主要应用在孵化项目组，已经上线的项目有4个，我是这块的服务器负责人。这套框架主要的出发点是全球同服，为了保证高可用，高性能，整合进去了公司很多互联网和微服务的基础设施，特别是容器化/性能监控和动态配置还有公司的日志库logid的支持。现在框架已经迭代的比较完善了。

     性能监控，公司的metrics系统，协议的数量，延迟，错误数，JVM等信息。目的：服务器的性能指标白盒化，及时发现问题，定位问题。

     日志库，logid的支持，非常方便的看到游戏中一条消息执行的完整链路。

     动态配置，配合工具，优化前后端发版流程。

  2. 调研和落地通用服务能力。现在已经落地的有几个，基本都是golang开发，并且已经部署在线上，海外也有部署。

     所有的服务要求能落地，经过性能压测后，提供线上服务。

  3. 其他项目上线前的风险评估和性能优化。主要是P7春节活动。

- 工具
  - 项目脚手架。服务器/机器人/TCP/HTTP/WS
  - 多语言配置。java/cs/lua/ts/cpp/uecpp
  - 平台工具，tcc、settings
  - 通知机制。
- 通用服务
  - 货币服务。芒果斗地主在用
  - 智能运营平台。P2、P3、P7在用，海外和国内
  - 匹配服务。P5、P7在用。这块需要再看下！
  - 网关服务。这块需要再看下！
  - 抖音社交服务。
- 框架
  - 整合公司基础设施，容器化。
  - 日志，服务发现，数据埋点
  - 性能监控
  - 流控，这块需要再看下！
  - 异步RPC
  - 多种协议加密支持。ChaCha20、AES
- 性能调优
  - P7春节活动

#### leetcode做过的题过一遍

#### sandbox项目过一遍

tcp：https://zhuanlan.zhihu.com/p/388704023

kcp：https://192.144.167.243/blog/93/

mongo 索引实现：https://mongoing.com/archives/2797

- 服务器框架，有脚手架自动生成，只需要简单的描述文件：
  - 比如，使用的idl文件，数据库，配置数据源，网络模式，要接入的rpc服务等，自动生成服务器项目和机器人项目，直接能run起来的。支持是否开启网关模式，方便本地调试。（目前支持tcp和ws，udp在下个双月的okr里，有个枪战类型的游戏准备接入）
  - 策划配置数据这块支持的比较全面，前后端包括java/cs/lua/ts/cpp/uecpp
  - 经典的actor模式，这里有一个背景是项目要求是数据的绝对安全，不能容忍数据回档，存储成功后才可以进行下一步操作。
  - 一条消息过来后封装成一个任务task，扔到线程池执行，同一个玩家的任务保证在同一个线程池执行，执行的过程中，主要要解决的问题就是IO操作，我们把io操作封装成子任务去执行（子任务和父任务都执行完，一个任务才算完成，这样同一个玩家的第一个消息没处理完的情况下，第二条消息是不会处理的）。
  - 数据存储我们使用的是mongo，支持同步和异步client，针对继承db对象的类使用java的enhancer进行动态代理，对方法进行拦截，统计dirty数据，调用save方法的时候自动存盘，支持rollback。
  - 性能监控，底层对消息的处理耗时p90,p99等，协议数量，失败率，JVM信息等打点，提供大盘数据模板，让服务器数据白盒化。30s一次打点，store打点，适用线程数连接数。counter历史累计，适用用户关注变化量，变化率。timer，30s内值进行计算min/max/avg/p90/p99等，接口耗时。rate，采样周期内累计/30s，只关注变化率。

## 帧同步

难点：

- 同步率问题
  - 必须保证一样输入在一样的环境下必须要有一致的结果，不能出现多端不一致的情况。
  - 浮点数和随机数
  - 发现不同步问题的机制：自动化测试automator，自动化测试脚本的优化，自动化测试结果的收集整理。
- 延迟&卡顿
  - 减少进程内部的时间损耗：
    1. 前端逻辑层
    2. 网络层数据收发
    3. 网络延迟指标40-60ms，操作延迟指标80-100ms
  - 平衡缓冲和延迟
    1. 缓冲帧多，对抗网络抖动，但增加玩家操作感延迟
    2. 动态调节0-5帧
    3. 合理预测网络延迟
  - 网络加速
    1. 协议字段精简
    2. 冗余包，若干个操作帧，应对丢包的情况
    3. 双通道方案，wifi对包，网络潮汐现象，采用wifi+4g，王者荣耀实装
    4. 就近部署和匹配，国内网络环境还行
    5. 边缘节点加速，海外环境效果明显
- 战斗验证问题
  - 服务器验证：后端验证？前端代码？逻辑和表现隔离，让后端跑逻辑库
  - 验证战斗裁剪，多人战斗上报不一致才验证，单人战斗设置数值门槛。
  - 战斗可追溯：出现战斗不一致，要能进行战斗追溯。客户端存本地存一定场次的战斗数据文件，服务器要求时上报sladar。
  - 误判？严格模式和非严格模式。

